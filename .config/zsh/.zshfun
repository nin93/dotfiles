function zle-timer-set() {
  timer=$(date +%s%0N)
}

function _tdiff() {
  if (($1 < 60)); then
    printf '%.3fs' "$1"
  elif (($1 < 3600)); then
    printf '%dm ' $(($1 / 60))
    _tdiff $(($1 % 60))
  else
    printf '%dh ' $(($1 / 3600))
    _tdiff $(($1 % 3600))
  fi
}

function mkcd() {
  mkdir -p "$1"
  cd "$1"
}

function zle-timer-diff() {
  if [[ $timer ]]; then
    now=$(date +%s%0N)
    seconds=$(echo "scale=3; $(($now-$timer)) / 1000000000" | bc)

    export RPROMPT="%{$fg[black]%}$(_tdiff $seconds)%{$reset_color%}"
    unset timer
  fi
}

preexec_functions+=(zle-timer-set)

precmd_functions+=(zle-timer-diff)

zle-keymap-select () {
  if [[ $KEYMAP == vicmd ]]; then
    # the normal mode for vi
    echo -ne "\e[2 q"
  else
    # the insert mode for vi
    echo -ne "\e[3 q"
  fi
}

precmd_functions+=(zle-keymap-select)

zle -N zle-keymap-select
